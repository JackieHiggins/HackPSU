{% extends "layout.html" %}
{% block content %}

<div class="content-card">
    <div class="prompt-display-header">
        <h4 class="prompt-title">Story Prompt</h4>
        <div class="emoji-prompt stories-page-prompt">
            {% for emoji in prompt.emojis.split() %}
                <span class="prompt-emoji">{{ emoji }}</span>
            {% endfor %}
        </div>
    </div>
    
    <div class="story-detail-card" id="story-{{ story.id }}">
        <div class="story-header">
            <h2 class="story-title-detail">{{ story.title }}</h2>
            <div class="author-info">
                <span class="author-name">by {{ story.author.username }}</span>
            </div>
            <div class="story-meta">
                <span class="story-timestamp">{{ story.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                <div class="story-actions">
                    <button class="heart-btn" data-story-id="{{ story.id }}" aria-label="like">
                        <span class="heart-icon {% if story.id in liked_stories %}liked{% endif %}">❤</span>
                        <span class="likes-count">{{ story.likes }}</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="story-content-full">
            {{ story.content }}
        </div>
    </div>

    <div class="comments-section">
        <h3 class="comments-title">Comments ({{ comments|length }})</h3>
        <div class="comments-container" id="comments-container">
            {% for comment in comments %}
            <div class="comment-card" id="comment-{{ comment.id }}">
                <p class="comment-meta">
                    <strong>{{ comment.author.username }}</strong>
                    <small>{{ comment.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                </p>
                <div class="comment-content" data-comment-id="{{ comment.id }}">{{ comment.content }}</div>
                <div class="comment-actions">
                    <button class="comment-like-btn" data-comment-id="{{ comment.id }}">
                        <span class="comment-heart-icon {% if comment.id in liked_comments %}liked{% endif %}">❤</span>
                        <span class="comment-likes-count">{{ comment.likes }}</span>
                    </button>
                    {% if comment.user_id == current_user.id %}
                    <button class="comment-edit-btn" data-comment-id="{{ comment.id }}">Edit</button>
                    {% endif %}
                </div>
                <div class="comment-edit-area" data-comment-id="{{ comment.id }}">
                    <textarea class="comment-edit-textarea">{{ comment.content }}</textarea>
                    <button class="btn btn-small save-comment-edit" data-comment-id="{{ comment.id }}">Save</button>
                    <button class="btn btn-small btn-secondary cancel-comment-edit" data-comment-id="{{ comment.id }}">Cancel</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <form class="comment-form" id="comment-form">
            <textarea name="content" placeholder="Add a comment..." required></textarea>
            <button type="submit" class="btn">Comment</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.heart-btn').addEventListener('click', function() {
        const storyId = this.dataset.storyId;
        fetch(`/stories/${storyId}/like`, { method: 'POST' }).then(res => res.json()).then(data => {
            this.querySelector('.likes-count').textContent = data.likes;
            this.querySelector('.heart-icon').classList.toggle('liked', data.liked);
        });
    });

    const commentsContainer = document.getElementById('comments-container');
    commentsContainer.addEventListener('click', function(e) {
        const target = e.target;
        const likeBtn = target.closest('.comment-like-btn');
        if (likeBtn) {
            const commentId = likeBtn.dataset.commentId;
            fetch(`/comment/${commentId}/like`, { method: 'POST' }).then(res => res.json()).then(data => {
                likeBtn.querySelector('.comment-likes-count').textContent = data.likes;
                likeBtn.querySelector('.comment-heart-icon').classList.toggle('liked', data.liked);
            });
        }
        const editBtn = target.closest('.comment-edit-btn');
        if (editBtn) {
            const card = document.getElementById(`comment-${editBtn.dataset.commentId}`);
            card.querySelector('.comment-edit-area').style.display = 'block';
            card.querySelector('.comment-content').style.display = 'none';
            editBtn.style.display = 'none';
        }
        const cancelBtn = target.closest('.cancel-comment-edit');
        if (cancelBtn) {
            const card = document.getElementById(`comment-${cancelBtn.dataset.commentId}`);
            card.querySelector('.comment-edit-area').style.display = 'none';
            card.querySelector('.comment-content').style.display = 'block';
            card.querySelector('.comment-edit-btn').style.display = 'inline-block';
        }
        const saveBtn = target.closest('.save-comment-edit');
        if (saveBtn) {
            const commentId = saveBtn.dataset.commentId;
            const card = document.getElementById(`comment-${commentId}`);
            const newContent = card.querySelector('.comment-edit-textarea').value;
            fetch(`/comment/${commentId}/edit`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: newContent })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    card.querySelector('.comment-content').textContent = data.content;
                    card.querySelector('.cancel-comment-edit').click();
                } else { alert(data.message || 'Error saving comment.'); }
            });
        }
    });

    document.getElementById('comment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const storyId = "{{ story.id }}";
        const formData = new FormData(this);
        fetch(`/story/${storyId}/comment`, { method: 'POST', body: formData }).then(res => res.json()).then(data => {
            if (data.success) {
                const c = data.comment;
                const html = `<div class="comment-card" id="comment-${c.id}"><p class="comment-meta"><strong>${c.username}</strong> <small>${c.timestamp}</small></p><div class="comment-content" data-comment-id="${c.id}">${c.content}</div><div class="comment-actions"><button class="comment-like-btn" data-comment-id="${c.id}"><span class="comment-heart-icon">❤</span> <span class="comment-likes-count">0</span></button> <button class="comment-edit-btn" data-comment-id="${c.id}">Edit</button></div><div class="comment-edit-area" data-comment-id="${c.id}"><textarea class="comment-edit-textarea">${c.content}</textarea><button class="btn btn-small save-comment-edit" data-comment-id="${c.id}">Save</button><button class="btn btn-small btn-secondary cancel-comment-edit" data-comment-id="${c.id}">Cancel</button></div></div>`;
                commentsContainer.insertAdjacentHTML('beforeend', html);
                this.reset();
            } else { alert(data.message || 'Could not post comment.'); }
        });
    });
});
</script>

{% endblock %}