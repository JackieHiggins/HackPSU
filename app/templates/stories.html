{% extends "layout.html" %}
{% block content %}

<div class="content-card">
    <h2 class="section-title">TODAY'S STORIES</h2>

    <div class="emoji-prompt stories-page-prompt">
        {% for emoji in prompt_emojis.split() %}
            <span class="prompt-emoji">{{ emoji }}</span>
        {% endfor %}
    </div>

    {% if stories %}
        <div class="stories-container">
            {% for story in stories %}
                <div class="story-card-link-wrapper">
                    <a href="{{ url_for('main.story_detail', story_id=story.id) }}" class="story-card-link">
                        <div class="story-card" id="story-{{ story.id }}">
                            <div class="story-header">
                                <div class="author-info">
                                    <span class="author-name {% if story.user_id == current_user.id %}is-you{% endif %}">
                                        {{ story.author.username }}
                                    </span>
                                </div>
                                <div class="story-meta">
                                    <span class="story-timestamp">{{ story.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                            </div>
                            <div class="story-content truncated">
                                {{ story.content }}
                            </div>
                            <div class="story-card-footer">
                                Click to read more and comment...
                            </div>
                        </div>
                    </a>
                    <div class="story-actions-standalone">
                        <button class="heart-btn" data-story-id="{{ story.id }}" aria-label="like">
                             <span class="heart-icon {% if story.id in liked_stories %}liked{% endif %}">‚ù§</span>
                            <span class="likes-count">{{ story.likes }}</span>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-stories">No stories found for this prompt yet.</p>
    {% endif %}
</div>

<script>
document.addEventListener('click', function(e) {
    const likeBtn = e.target.closest('.heart-btn');
    if (likeBtn) {
        e.preventDefault();
        const storyId = likeBtn.dataset.storyId;
        fetch(`/stories/${storyId}/like`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
        }).then(r => r.json()).then(data => {
            if (data && data.error === undefined) {
                likeBtn.querySelector('.likes-count').textContent = data.likes;
                const heartIcon = likeBtn.querySelector('.heart-icon');
                heartIcon.classList.toggle('liked', data.liked);
            }
        });
    }
});
</script>

{% endblock %}