{% extends "layout.html" %}

{% block content %}
<div class="content-card" style="text-align: left;"> 
    
    <h2 class="section-title" style="text-align: center;">TODAY'S PROMPT</h2>
    <p style="text-align: center;">Write a short story inspired by the emojis below.</p>
    
    <div class="emoji-prompt">
        {% for emoji in emojis.split() %}
            <span class="prompt-emoji">{{ emoji }}</span>
        {% endfor %}
    </div>

    {% if user_story %}
        <h3>You've submitted your story for today!</h3>
        <div class="submitted-story-card" id="story-{{ user_story.id }}">
            <h4 class="story-title" data-story-id="{{ user_story.id }}">{{ user_story.title }}</h4>
            
            <div class="story-content" data-story-id="{{ user_story.id }}">
                {{ user_story.content }}
            </div>
            
            <div class="edit-area" data-story-id="{{ user_story.id }}">
                <input type="text" class="edit-title-input" value="{{ user_story.title }}">
                <textarea class="edit-textarea">{{ user_story.content }}</textarea>
                <div class="edit-buttons">
                    <button class="btn save-edit" data-story-id="{{ user_story.id }}">Save</button>
                    <button class="btn cancel-edit" data-story-id="{{ user_story.id }}">Cancel</button>
                </div>
            </div>

            <div class="dashboard-actions">
                <button class="btn edit-btn" data-story-id="{{ user_story.id }}">Edit Your Story</button>
                <a href="{{ url_for('main.stories') }}" class="btn view_stories_btn">View All Stories</a>
            </div>
        </div>
    {% else %}
        <h3>Submit Your Story</h3>
        <form action="{{ url_for('main.submit_story') }}" method="POST" class="story-form">
            <p>
                <input type="text" name="story_title" placeholder="Enter a title for your story" required>
            </p>
            <p>
                <textarea name="story_content" placeholder="Once upon a time..."></textarea>
            </p>
            <p>
                <button type="submit" class="btn">Submit Story</button>
            </p>
        </form>
        <small style="color: #666; text-align: right; display: block;">Note: You must submit your story before you can view others' submissions.</small>
    {% endif %}
</div>

{% if user_story %}
<script>
document.addEventListener('click', function(e) {
    const storyId = "{{ user_story.id }}";
    const editArea = document.querySelector(`.edit-area[data-story-id='${storyId}']`);

    if (e.target.matches('.edit-btn')) {
        editArea.style.display = 'block';
        document.querySelector(`.story-content[data-story-id='${storyId}']`).style.display = 'none';
        document.querySelector(`.story-title[data-story-id='${storyId}']`).style.display = 'none';
        e.target.style.display = 'none';
    }

    if (e.target.matches('.cancel-edit')) {
        editArea.style.display = 'none';
        document.querySelector(`.story-content[data-story-id='${storyId}']`).style.display = 'block';
        document.querySelector(`.story-title[data-story-id='${storyId}']`).style.display = 'block';
        document.querySelector('.edit-btn').style.display = 'inline-block';
    }

    if (e.target.matches('.save-edit')) {
        const newTitle = editArea.querySelector('.edit-title-input').value.trim();
        const newContent = editArea.querySelector('.edit-textarea').value.trim();
        
        if (!newTitle) { alert('Title cannot be empty.'); return; }
        if (newContent.length < 10) { alert('Story must be at least 10 characters.'); return; }

        fetch(`/stories/${storyId}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle, content: newContent })
        }).then(r => r.json()).then(data => {
            if (data.success) {
                document.querySelector(`.story-title[data-story-id='${storyId}']`).textContent = data.title;
                document.querySelector(`.story-content[data-story-id='${storyId}']`).textContent = data.content;
                document.querySelector('.cancel-edit').click();
            } else {
                alert(data.message || 'Failed to update story.');
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}